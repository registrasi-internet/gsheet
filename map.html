<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Registrasi (Solusi Final)</title>
    
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 300px; }
        #autocomplete-container { position: relative; }
        #autocomplete-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background-color: white; border: 1px solid #e2e8f0; border-top: none;
            border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            z-index: 1000; max-height: 200px; overflow-y: auto;
        }
        .autocomplete-item { padding: 0.75rem 1rem; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto p-6 md:p-8 bg-white rounded-xl shadow-2xl">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Registrasi Internet</h1>
            <p class="text-gray-500 mt-2">Ketik alamat atau gunakan deteksi GPS.</p>
        </div>

        <form id="registrationForm">
            <!-- Input standar -->
            <div class="mb-5">
                <label for="nama" class="block mb-2 text-sm font-medium text-gray-700">Nama Lengkap</label>
                <input type="text" id="nama" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
            </div>
            <div class="mb-5">
                <label for="whatsapp" class="block mb-2 text-sm font-medium text-gray-700">No. WhatsApp</label>
                <input type="tel" id="whatsapp" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
            </div>

            <!-- Input Alamat dengan Tombol Lokasi -->
            <div class="mb-4">
                <label for="alamat" class="block mb-2 text-sm font-medium text-gray-700">Alamat Lengkap</label>
                <div class="flex items-center space-x-2">
                    <div class="relative w-full" id="autocomplete-container">
                        <input type="text" id="alamat" name="alamat" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="Ketik alamat di Pontianak..." required autocomplete="off">
                        <div id="autocomplete-results"></div>
                    </div>
                    <button type="button" id="find-me-btn" title="Gunakan Lokasi Saya" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
            </div>

            <!-- Kontainer Peta -->
            <div class="mb-6">
                <div id="map" class="w-full bg-gray-200 rounded-lg z-0"></div>
                <p id="map-status" class="text-center text-sm text-gray-500 mt-2 h-5">Geser pin untuk lokasi yang lebih akurat.</p>
            </div>

            <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-3 text-center">Daftar Sekarang</button>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mapboxAccessToken = "pk.eyJ1Ijoia2F6aWVuIiwiYSI6ImNtZDY0ZXlvaTA1eGoyd3B2aDFmbGZsaWEifQ.IzmtPgnjElZVOJ5VIGOZsQ"; 
            
            const alamatInput = document.getElementById('alamat');
            const resultsContainer = document.getElementById('autocomplete-results');
            const mapStatus = document.getElementById('map-status');
            const findMeBtn = document.getElementById('find-me-btn');
            
            const defaultLocation = [-0.024, 109.33];
            const map = L.map('map').setView(defaultLocation, 13);
            let marker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
            let debounceTimeout;
            const pontianakBoundingBox = [109.25, -0.1, 109.45, 0.05].join(',');

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19, id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, accessToken: mapboxAccessToken
            }).addTo(map);

            // --- FUNGSI DETEKSI LOKASI GPS ---
            function findCurrentLocation() {
                mapStatus.textContent = "Meminta izin akses lokasi...";
                // PENTING: Fitur ini memerlukan koneksi aman (HTTPS) untuk berfungsi di browser modern.
                if (!navigator.geolocation) {
                    mapStatus.textContent = "Browser Anda tidak mendukung Geolocation.";
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude, accuracy } = position.coords;
                        mapStatus.textContent = `Akurasi lokasi: ${Math.round(accuracy)} meter.`;
                        const newLatLng = L.latLng(latitude, longitude);
                        map.setView(newLatLng, 17);
                        marker.setLatLng(newLatLng);
                        reverseGeocode(latitude, longitude);
                    },
                    (error) => {
                        let message = "Gagal mendapatkan lokasi. ";
                        if (error.code === 1) {
                            // Ini adalah kasus yang Anda alami.
                            message = "Izin lokasi diblokir oleh browser. Cek pengaturan (ikon gembok) atau gunakan koneksi HTTPS.";
                        } else if (error.code === 2) {
                            message += "Sinyal lokasi tidak tersedia.";
                        } else {
                            message += "Waktu permintaan habis.";
                        }
                        mapStatus.textContent = message;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            // --- FUNGSI REVERSE GEOCODING (KOORDINAT -> ALAMAT) ---
            function reverseGeocode(lat, lon) {
                mapStatus.textContent = "Mencari nama alamat dari titik...";
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?access_token=${mapboxAccessToken}`;
                fetch(url).then(res => res.json()).then(data => {
                    if (data.features && data.features.length > 0) {
                        alamatInput.value = data.features[0].place_name;
                        mapStatus.textContent = "Lokasi ditemukan! Geser pin jika perlu.";
                    }
                });
            }

            // --- FUNGSI PENCARIAN MANUAL (REAL-TIME) ---
            alamatInput.addEventListener('input', () => {
                const query = alamatInput.value;
                resultsContainer.innerHTML = '';
                if (query.length < 3) return;

                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?country=id&autocomplete=true&bbox=${pontianakBoundingBox}&access_token=${mapboxAccessToken}`;
                    fetch(url).then(res => res.json()).then(data => {
                        if (data.features) {
                            data.features.forEach(feature => {
                                const item = document.createElement('div');
                                item.className = 'autocomplete-item';
                                item.textContent = feature.place_name;
                                item.onclick = () => {
                                    const [lon, lat] = feature.center;
                                    alamatInput.value = feature.place_name;
                                    resultsContainer.innerHTML = '';
                                    map.setView([lat, lon], 17);
                                    marker.setLatLng([lat, lon]);
                                };
                                resultsContainer.appendChild(item);
                            });
                        }
                    });
                }, 350);
            });

            // --- EVENT LISTENERS LAINNYA ---
            findMeBtn.addEventListener('click', findCurrentLocation);
            marker.on('dragend', e => reverseGeocode(e.target.getLatLng().lat, e.target.getLatLng().lng));
            document.addEventListener('click', e => {
                if (!document.getElementById('autocomplete-container').contains(e.target)) {
                    resultsContainer.innerHTML = '';
                }
            });
            document.getElementById('registrationForm').addEventListener('submit', e => {
                e.preventDefault();
                alert('Formulir siap dikirim!');
            });
        });
    </script>
</body>
</html>
