<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Halaman Kelola Tagihan</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF & html2canvas for PDF/Image Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 14px; }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #invoice-printable-area, #invoice-printable-area * {
                visibility: visible;
            }
            #invoice-printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 20px;
                margin: 0;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
    
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const icons = {
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>,
            ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6" /></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></svg>,
            Bot: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 8V4H8" /><rect x="4" y="12" width="16" height="8" rx="2" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="M12 12v.01" /></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6" /></svg>,
            ChevronsLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="11 17 6 12 11 7" /><polyline points="18 17 13 12 18 7" /></svg>,
            ChevronsRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="13 17 18 12 13 7" /><polyline points="6 17 11 12 6 7" /></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Spinner: ({ className, ...props }) => {
                const finalClassName = ['animate-spin', className].filter(Boolean).join(' ');
                return (
                    <svg className={finalClassName} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" {...props}>
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                );
            },
        };

        const { useState, useMemo, useEffect, useCallback } = React;
        const { FileText, X, Search, ChevronLeft, AlertTriangle, Bot, ChevronRight, ChevronsLeft, ChevronsRight, Download, Camera, CheckCircle, Spinner } = icons;

        // --- UI COMPONENTS ---
        
        const ToastNotification = ({ message, type, onHide }) => {
            useEffect(() => {
                const timer = setTimeout(onHide, 3000);
                return () => clearTimeout(timer);
            }, [onHide]);

            const baseClasses = "fixed bottom-5 right-5 flex items-center p-4 rounded-lg shadow-lg text-white transition-transform transform animate-fade-in-up z-[100]";
            const typeClasses = {
                success: "bg-green-500",
                error: "bg-red-500",
            };

            return (
                <div className={`${baseClasses} ${typeClasses[type] || 'bg-gray-800'}`}>
                    <CheckCircle className="h-6 w-6 mr-3" />
                    <span>{message}</span>
                </div>
            );
        };

        const StatusBadge = ({ status, size = 'sm' }) => {
            const baseClasses = "font-medium rounded-full inline-block";
            const sizeClasses = { sm: "px-2.5 py-0.5 text-xs", lg: "px-4 py-1 text-sm" };
            let colorClasses = "";
            switch (status) {
                case 'Lunas': colorClasses = "bg-green-100 text-green-800"; break;
                case 'Belum Dibayar': colorClasses = "bg-yellow-100 text-yellow-800"; break;
                case 'Jatuh Tempo': colorClasses = "bg-red-100 text-red-800"; break;
                default: colorClasses = "bg-gray-100 text-gray-800";
            }
            return <span className={`${baseClasses} ${sizeClasses[size]} ${colorClasses}`}>{status}</span>;
        };
        const SearchBar = ({ searchTerm, setSearchTerm, placeholder }) => (
            <div className='relative flex-grow'>
                <input type='text' placeholder={placeholder} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className='border border-gray-300 rounded-md pl-10 pr-4 py-2 w-full focus:ring-blue-500 focus:border-blue-500 text-sm' />
                <Search className='absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400' />
            </div>
        );
        const Pagination = ({ currentPage, totalPages, onPageChange }) => {
            if (totalPages <= 1) return null;
            return (
                <div className="flex justify-between items-center mt-4">
                    <button onClick={() => onPageChange(1)} disabled={currentPage === 1} className="p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"><ChevronsLeft size={20} /></button>
                    <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"><ChevronLeft size={20} /></button>
                    <span className="text-sm text-gray-700">Halaman {currentPage} dari {totalPages}</span>
                    <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"><ChevronRight size={20} /></button>
                    <button onClick={() => onPageChange(totalPages)} disabled={currentPage === totalPages} className="p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"><ChevronsRight size={20} /></button>
                </div>
            );
        };
        const Modal = ({ isOpen, onClose, children, title, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClasses = { 'md': 'max-w-md', 'lg': 'max-w-lg', 'xl': 'max-w-xl', '3xl': 'max-w-3xl' };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className={`bg-white rounded-xl shadow-2xl w-full ${sizeClasses[size]} transform animate-fade-in-up max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-5 border-b sticky top-0 bg-white z-10 no-print"><h2 className="text-lg font-semibold text-gray-800">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X /></button></div>
                        <div className="overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children, isConfirming }) => (
            <Modal isOpen={isOpen} onClose={onClose} title={title} size="md">
                <div className="p-6 text-center">
                    <AlertTriangle className="mx-auto h-12 w-12 text-red-400" />
                    <h3 className="mt-2 text-lg font-medium text-gray-900">{title}</h3>
                    <div className="mt-2 text-sm text-gray-500">{children}</div>
                </div>
                <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-xl">
                    <button type="button" disabled={isConfirming} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm disabled:bg-red-400" onClick={onConfirm}>
                        {isConfirming ? <Spinner className="h-5 w-5"/> : "Ya, Lanjutkan"}
                    </button>
                    <button type="button" disabled={isConfirming} className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm disabled:opacity-50" onClick={onClose}>Batal</button>
                </div>
            </Modal>
        );
        const InvoiceModal = ({ isOpen, onClose, invoiceData, companyProfile, showToast }) => {
            const [isDownloading, setIsDownloading] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false);
            
            if (!isOpen || !invoiceData) return null;
            const { invoice, customer, service, product } = invoiceData;
            
            const handleCaptureImage = async () => {
                setIsCapturing(true);
                const invoiceElement = document.getElementById('invoice-printable-area');
                try {
                    const canvas = await html2canvas(invoiceElement, { scale: 2, logging: false });
                    const image = canvas.toDataURL('image/jpeg', 0.9);
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `Screenshot-Invoice-${invoice.id}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Gambar berhasil diunduh!');
                } catch (error) {
                    console.error("Gagal mengambil tangkapan layar:", error);
                    showToast('Gagal menyimpan gambar. Silakan coba lagi.', 'error');
                } finally {
                    setIsCapturing(false);
                }
            };

            const handleDownloadPdf = async () => {
                setIsDownloading(true);
                const { jsPDF } = window.jspdf;
                const invoiceElement = document.getElementById('invoice-printable-area');
                
                try {
                    const canvas = await html2canvas(invoiceElement, { scale: 2, logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`Invoice-${invoice.id}.pdf`);
                    showToast('PDF berhasil diunduh!');
                } catch (error) {
                    console.error("Gagal membuat PDF:", error);
                    showToast('Gagal membuat PDF.', 'error');
                } finally {
                    setIsDownloading(false);
                }
            };

            const formatDate = (date) => new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const formatCurrency = (amount) => `Rp ${Number(amount).toLocaleString('id-ID')}`;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Invoice #${invoice.id}`} size="3xl">
                    <div id="invoice-printable-area" className="p-4 sm:p-8 bg-white text-gray-800">
                        {/* **[DIPERBAIKI] Layout Header Invoice dengan Spacer** */}
                        <div className="flex items-start mb-8">
                            {/* Kolom Kiri */}
                            <div>
                                <svg className="h-10 w-auto mb-4 text-blue-600" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M64 0C28.7 0 0 28.7 0 64C0 99.3 28.7 128 64 128C99.3 128 128 99.3 128 64C128 28.7 99.3 0 64 0ZM87.5 90.2H74.3L64 74.8L53.7 90.2H40.5L58.5 64L40.5 37.8H53.7L64 53.2L74.3 37.8H87.5L69.5 64L87.5 90.2Z" fill="currentColor"/>
                                </svg>
                                <h2 className="font-bold text-gray-800">{companyProfile.name}</h2>
                                <p className="text-sm text-gray-600">{companyProfile.email}</p>
                            </div>

                            {/* Spacer yang mendorong kolom kanan */}
                            <div className="flex-grow"></div>

                            {/* Kolom Kanan */}
                            <div className="text-right">
                                <h1 className="text-3xl font-bold text-gray-800 uppercase">INVOICE</h1>
                                <p className="text-sm text-gray-500 mt-1"># {invoice.id}</p>
                                <div className="mt-4">
                                    <StatusBadge status={invoice.status} size="lg" />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-8 mb-8">
                            <div>
                                <p className="text-sm font-semibold text-gray-500 uppercase">Ditagihkan Kepada</p>
                                <p className="font-bold text-gray-800 mt-1">{customer.name}</p>
                                <p className="text-sm text-gray-600">{customer.email}</p>
                                <p className="text-sm text-gray-600">{customer.whatsapp}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-sm font-semibold text-gray-500 uppercase">Tanggal Invoice</p>
                                <p className="font-medium text-gray-800 mt-1">{formatDate(new Date())}</p>
                                <p className="text-sm font-semibold text-gray-500 uppercase mt-4">Jatuh Tempo</p>
                                <p className="font-medium text-gray-800 mt-1">{formatDate(invoice.dueDate)}</p>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="py-3 px-4 text-left font-semibold text-gray-600 uppercase">Deskripsi</th>
                                        <th className="py-3 px-4 text-center font-semibold text-gray-600 uppercase">Kuantitas</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-600 uppercase">Harga</th>
                                        <th className="py-3 px-4 text-right font-semibold text-gray-600 uppercase">Total</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    <tr>
                                        <td className="py-3 px-4 text-left">
                                            <p className="font-medium">{product.name} - {service.name}</p>
                                            <p className="text-xs text-gray-500">Siklus: {product.cycle}</p>
                                        </td>
                                        <td className="py-3 px-4 text-center">1</td>
                                        <td className="py-3 px-4 text-right">{formatCurrency(invoice.amount)}</td>
                                        <td className="py-3 px-4 text-right font-medium">{formatCurrency(invoice.amount)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div className="flex justify-end mt-8">
                            <div className="w-full max-w-xs">
                                <div className="flex justify-between text-gray-600">
                                    <p>Subtotal</p>
                                    <p>{formatCurrency(invoice.amount)}</p>
                                </div>
                                <div className="flex justify-between text-gray-600 mt-2">
                                    <p>Pajak (0%)</p>
                                    <p>{formatCurrency(0)}</p>
                                </div>
                                <div className="border-t my-2"></div>
                                <div className="flex justify-between font-bold text-lg text-gray-800">
                                    <p>Total Tagihan</p>
                                    <p>{formatCurrency(invoice.amount)}</p>
                                </div>
                            </div>
                        </div>
                        <div className="border-t mt-8 pt-6 text-sm text-gray-600">
                            <h3 className="font-semibold text-gray-800 mb-2">Instruksi Pembayaran</h3>
                            <p>Silakan lakukan pembayaran ke rekening berikut:</p>
                            <p className="font-medium mt-1">Bank XYZ - 1234567890 a/n {companyProfile.name}</p>
                            <p className="mt-4">Terima kasih atas kepercayaan Anda.</p>
                        </div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-b-xl flex justify-end items-center gap-3 no-print">
                        <button onClick={handleCaptureImage} disabled={isCapturing || isDownloading} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 flex items-center gap-2 disabled:opacity-50">
                            {isCapturing ? <Spinner className="h-4 w-4" /> : <Camera size={16} />}
                            {isCapturing ? 'Menyimpan...' : 'Tangkap Layar (JPG)'}
                        </button>
                        <button onClick={handleDownloadPdf} disabled={isDownloading || isCapturing} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 flex items-center gap-2 disabled:opacity-50">
                            {isDownloading ? <Spinner className="h-4 w-4" /> : <Download size={16} />}
                            {isDownloading ? 'Mengunduh...' : 'Download PDF'}
                        </button>
                        <button onClick={onClose} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Tutup</button>
                    </div>
                </Modal>
            );
        };

        // --- THE INVOICE PAGE COMPONENT ---
        const TagihanView = ({ invoices, customers, services, products, onUpdateInvoiceStatus, onRunBillingCheck, onViewInvoice }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [automationResult, setAutomationResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const ITEMS_PER_PAGE = 10;

            const invoicesWithDetails = useMemo(() => invoices.map(invoice => { 
                const customer = customers.find(c => c.id === invoice.customerId); 
                const service = services.find(s => s.id === invoice.serviceId); 
                const product = service ? products.find(p => p.id === service.productId) : null; 
                return { 
                    ...invoice, 
                    customer, 
                    service, 
                    product, 
                    customerName: customer ? customer.name : 'N/A', 
                    customerIdentifier: customer ? customer.customerId : '', 
                    dueDateFormatted: new Date(invoice.dueDate).toLocaleDateString('id-ID'), 
                    serviceType: service ? service.type : 'N/A', 
                    productName: product ? product.name : 'N/A' 
                }; 
            }), [invoices, customers, services, products]);

            const filteredInvoices = useMemo(() => invoicesWithDetails.filter(i => 
                i.id.toLowerCase().includes(searchTerm.toLowerCase()) || 
                i.customerName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (i.service && i.service.name.toLowerCase().includes(searchTerm.toLowerCase()))
            ), [invoicesWithDetails, searchTerm]);

            const paginatedInvoices = useMemo(() => { 
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE; 
                return filteredInvoices.slice(startIndex, startIndex + ITEMS_PER_PAGE); 
            }, [filteredInvoices, currentPage]);

            const totalPages = Math.ceil(filteredInvoices.length / ITEMS_PER_PAGE);

            const handleRunCheck = async () => { 
                setIsLoading(true); 
                setAutomationResult(null); 
                await new Promise(resolve => setTimeout(resolve, 1500));
                const count = await onRunBillingCheck(); 
                setAutomationResult(`Proses simulasi selesai. ${count} tagihan baru akan dibuat.`); 
                setIsLoading(false); 
            };
            
            return (
                <div className="p-4 md:p-6 space-y-6">
                    <div className="bg-white p-4 md:p-6 rounded-xl border shadow-sm">
                        <h3 className="text-lg font-semibold mb-4">Pusat Otomatisasi Tagihan</h3>
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                            <div className="flex">
                                <div className="py-1"><Bot className="h-6 w-6 text-blue-500 mr-4" /></div>
                                <div>
                                    <p className="font-semibold text-blue-800">Otomatisasi Penagihan</p>
                                    <p className="text-sm text-blue-700 mt-1">Pindai semua layanan yang akan kedaluwarsa (dalam 30 hari) dan belum memiliki tagihan untuk dibuatkan secara otomatis.</p>
                                    <button onClick={handleRunCheck} disabled={isLoading} className="mt-4 inline-flex items-center px-4 py-2 border text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300">
                                        {isLoading ? <Spinner className="h-5 w-5 mr-2" /> : null}
                                        {isLoading ? 'Memproses...' : 'Jalankan Pemeriksaan'}
                                    </button>
                                    {automationResult && <p className="mt-3 text-sm font-semibold text-green-700">{automationResult}</p>}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white p-4 md:p-6 rounded-xl border shadow-sm">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <h3 className="text-lg font-semibold">Daftar Semua Tagihan</h3>
                            <div className='w-full md:w-1/3'>
                                <SearchBar searchTerm={searchTerm} setSearchTerm={setSearchTerm} placeholder='Cari ID, nama, atau layanan...' />
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {['Tagihan', 'Layanan', 'Pelanggan', 'Jatuh Tempo', 'Status', 'Aksi'].map(h => 
                                            <th key={h} className="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">{h}</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y">
                                    {paginatedInvoices.map(invoice => (
                                        <tr key={invoice.id} className="hover:bg-gray-50">
                                            <td className="py-3 px-4 font-medium text-blue-600">{invoice.id}</td>
                                            <td className="py-3 px-4">
                                                <div>{invoice.productName}</div>
                                                <div className="text-xs text-gray-500">{invoice.service.name}</div>
                                            </td>
                                            <td className="py-3 px-4">
                                                <div>{invoice.customerName}</div>
                                                <div className="text-xs text-gray-500">{invoice.customerIdentifier}</div>
                                            </td>
                                            <td className="py-3 px-4 font-semibold text-red-600">{invoice.dueDateFormatted}</td>
                                            <td className="py-3 px-4 text-center"><StatusBadge status={invoice.status} /></td>
                                            <td className="py-3 px-4 text-center flex items-center justify-center gap-2">
                                                <button onClick={() => onViewInvoice(invoice)} className='bg-blue-500 text-white font-semibold px-3 py-1.5 rounded-md text-xs'>Lihat</button>
                                                {(invoice.status === 'Belum Dibayar' || invoice.status === 'Jatuh Tempo') && (
                                                    <button onClick={() => onUpdateInvoiceStatus(invoice.id, 'Lunas')} className='bg-green-500 text-white font-semibold px-3 py-1.5 rounded-md text-xs'>Lunas</button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            // --- MOCK DATA ---
            const [customers, setCustomers] = useState([
                {id: 1, customerId: 'CUST-001', name: 'Budi Santoso', email: 'budi.s@example.com', whatsapp: '081234567890'},
                {id: 2, customerId: 'CUST-002', name: 'Citra Lestari', email: 'citra.l@example.com', whatsapp: '082345678901'},
            ]);
            const [products, setProducts] = useState([
                {id: 101, name: 'Hosting Personal', type: 'Hosting', price: 250000, cycle: 'Tahunan'},
                {id: 102, name: 'Domain .COM', type: 'Domain', price: 150000, cycle: 'Tahunan'},
            ]);
            const [services, setServices] = useState([
                {id: 1001, customerId: 1, productId: 101, name: 'budisantoso.com', price: 250000, expiryDate: new Date('2025-08-15')},
                {id: 1002, customerId: 2, productId: 102, name: 'citralestari.com', price: 150000, expiryDate: new Date('2025-07-30')},
                {id: 1003, customerId: 1, productId: 102, name: 'tokobudi.com', price: 150000, expiryDate: new Date('2024-07-20')},
            ]);
            const [invoices, setInvoices] = useState([
                {id: 'INV-2025-001', customerId: 1, serviceId: 1001, amount: 250000, status: 'Belum Dibayar', dueDate: new Date('2025-08-01')},
                {id: 'INV-2025-002', customerId: 2, serviceId: 1002, amount: 150000, status: 'Lunas', dueDate: new Date('2025-07-15')},
                {id: 'INV-2024-003', customerId: 1, serviceId: 1003, amount: 150000, status: 'Jatuh Tempo', dueDate: new Date('2024-07-10')},
            ]);
             const [companyProfile, setCompanyProfile] = useState({ name: 'Hostindo Pratama', email: 'billing@hostindo.com' });

            // --- STATE MANAGEMENT ---
            const [invoiceModalData, setInvoiceModalData] = useState(null);
            const [confirmModalState, setConfirmModalState] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [isConfirming, setIsConfirming] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

            // --- HANDLERS ---
            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
            };

            const handleViewInvoice = (invoice) => {
                setInvoiceModalData({
                    invoice,
                    customer: customers.find(c => c.id === invoice.customerId),
                    service: services.find(s => s.id === invoice.serviceId),
                    product: products.find(p => p.id === (services.find(s => s.id === invoice.serviceId) || {}).productId)
                });
            };

            const handleUpdateInvoiceStatus = (invoiceId, newStatus) => {
                setConfirmModalState({
                    isOpen: true,
                    title: "Konfirmasi Pembayaran",
                    message: `Apakah Anda yakin ingin menandai tagihan ${invoiceId} sebagai Lunas?`,
                    onConfirm: async () => {
                        setIsConfirming(true);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        setInvoices(prevInvoices => prevInvoices.map(inv => 
                            inv.id === invoiceId ? { ...inv, status: newStatus } : inv
                        ));
                        
                        setIsConfirming(false);
                        setConfirmModalState({ isOpen: false });
                        showToast(`Tagihan ${invoiceId} telah ditandai Lunas.`);
                    }
                });
            };

            const handleRunBillingCheck = () => {
                return Math.floor(Math.random() * 5);
            };

            return (
                <div>
                    <header className="bg-white p-4 shadow-md">
                        <h1 className="text-xl font-bold text-gray-800">Kelola Tagihan</h1>
                    </header>
                    <main>
                        <TagihanView 
                            invoices={invoices}
                            customers={customers}
                            services={services}
                            products={products}
                            onUpdateInvoiceStatus={handleUpdateInvoiceStatus}
                            onRunBillingCheck={handleRunBillingCheck}
                            onViewInvoice={handleViewInvoice}
                        />
                    </main>
                    <InvoiceModal 
                        isOpen={!!invoiceModalData} 
                        onClose={() => setInvoiceModalData(null)} 
                        invoiceData={invoiceModalData}
                        companyProfile={companyProfile}
                        showToast={showToast}
                    />
                    <ConfirmationModal
                        isOpen={confirmModalState.isOpen}
                        onClose={() => setConfirmModalState({ isOpen: false })}
                        onConfirm={confirmModalState.onConfirm}
                        title={confirmModalState.title}
                        isConfirming={isConfirming}
                    >
                        {confirmModalState.message}
                    </ConfirmationModal>
                    {toast.show && (
                        <ToastNotification 
                            message={toast.message} 
                            type={toast.type} 
                            onHide={() => setToast({ ...toast, show: false })} 
                        />
                    )}
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
